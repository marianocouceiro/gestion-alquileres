<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Gesti√≥n de Alquileres</title>
    <link href="https://fonts.googleapis.com/css2?family=Manrope:wght@400;500;600;700;800&family=Montserrat:wght@700;900&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary: #2b5876;
            --primary-light: #4e89ae;
            --primary-dark: #1a3a4d;
            --accent: #f39c12;
            --accent-bright: #f1c40f;
            --danger: #e74c3c;
            --success: #27ae60;
            --warning: #ff6b6b;
            --bg-main: #f8f9fa;
            --bg-card: #ffffff;
            --text-primary: #2c3e50;
            --text-secondary: #7f8c8d;
            --border: #e0e6ed;
            --shadow: rgba(43, 88, 118, 0.08);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Manrope', sans-serif;
            background: var(--bg-main);
            color: var(--text-primary);
            line-height: 1.6;
        }

        .header {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-light) 100%);
            color: white;
            padding: 2rem 0;
            box-shadow: 0 4px 20px var(--shadow);
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .header-content {
            max-width: 1400px;
            margin: 0 auto;
            padding: 0 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .logo-icon {
            width: 50px;
            height: 50px;
            background: white;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.8rem;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }

        .logo h1 {
            font-family: 'Montserrat', sans-serif;
            font-size: 1.8rem;
            font-weight: 900;
            letter-spacing: -0.5px;
        }

        .header-stats {
            display: flex;
            gap: 2rem;
        }

        .stat-item {
            text-align: center;
        }

        .stat-value {
            font-size: 1.8rem;
            font-weight: 800;
            display: block;
        }

        .stat-label {
            font-size: 0.85rem;
            opacity: 0.9;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 2rem;
        }

        .alert-banner {
            background: linear-gradient(135deg, var(--warning) 0%, var(--danger) 100%);
            color: white;
            padding: 1.5rem;
            border-radius: 16px;
            margin-bottom: 2rem;
            display: none;
            align-items: center;
            gap: 1rem;
            box-shadow: 0 8px 24px rgba(255, 107, 107, 0.3);
            animation: slideDown 0.5s ease;
        }

        .alert-banner.show {
            display: flex;
        }

        .alert-icon {
            font-size: 2rem;
            animation: pulse 2s infinite;
        }

        .alert-content h3 {
            font-size: 1.2rem;
            margin-bottom: 0.25rem;
        }

        .tabs {
            display: flex;
            gap: 1rem;
            margin-bottom: 2rem;
            border-bottom: 2px solid var(--border);
            flex-wrap: wrap;
        }

        .tab {
            padding: 1rem 2rem;
            background: transparent;
            border: none;
            color: var(--text-secondary);
            font-weight: 600;
            font-size: 1rem;
            cursor: pointer;
            position: relative;
            transition: all 0.3s;
            border-radius: 8px 8px 0 0;
        }

        .tab:hover {
            color: var(--primary);
            background: rgba(43, 88, 118, 0.05);
        }

        .tab.active {
            color: var(--primary);
            background: var(--bg-card);
        }

        .tab.active::after {
            content: '';
            position: absolute;
            bottom: -2px;
            left: 0;
            right: 0;
            height: 3px;
            background: var(--primary);
            border-radius: 3px 3px 0 0;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
            animation: fadeIn 0.3s ease;
        }

        .card {
            background: var(--bg-card);
            border-radius: 16px;
            padding: 2rem;
            box-shadow: 0 4px 20px var(--shadow);
            margin-bottom: 2rem;
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
            padding-bottom: 1rem;
            border-bottom: 2px solid var(--border);
        }

        .card-title {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--primary);
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 1.5rem;
            margin-bottom: 1.5rem;
        }

        .form-group {
            display: flex;
            flex-direction: column;
        }

        .form-group label {
            font-weight: 600;
            margin-bottom: 0.5rem;
            color: var(--text-primary);
            font-size: 0.95rem;
        }

        .form-group input,
        .form-group select {
            padding: 0.875rem;
            border: 2px solid var(--border);
            border-radius: 10px;
            font-size: 1rem;
            font-family: 'Manrope', sans-serif;
            transition: all 0.3s;
            background: white;
        }

        .form-group input:focus,
        .form-group select:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(43, 88, 118, 0.1);
        }

        .btn {
            padding: 1rem 2rem;
            border: none;
            border-radius: 10px;
            font-weight: 600;
            font-size: 1rem;
            cursor: pointer;
            transition: all 0.3s;
            font-family: 'Manrope', sans-serif;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            justify-content: center;
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-light) 100%);
            color: white;
            box-shadow: 0 4px 15px rgba(43, 88, 118, 0.3);
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(43, 88, 118, 0.4);
        }

        .btn-secondary {
            background: var(--bg-main);
            color: var(--text-primary);
            border: 2px solid var(--border);
        }

        .btn-secondary:hover {
            background: var(--border);
        }

        .btn-danger {
            background: var(--danger);
            color: white;
        }

        .btn-danger:hover {
            background: #c0392b;
        }

        .filters {
            display: flex;
            gap: 1rem;
            margin-bottom: 2rem;
            flex-wrap: wrap;
            align-items: center;
        }

        .filter-group {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .filter-group select,
        .filter-group input {
            padding: 0.75rem 1rem;
            border: 2px solid var(--border);
            border-radius: 8px;
            font-size: 0.95rem;
            font-family: 'Manrope', sans-serif;
        }

        .table-container {
            overflow-x: auto;
            border-radius: 12px;
            border: 1px solid var(--border);
        }

        table {
            width: 100%;
            border-collapse: collapse;
            background: white;
        }

        thead {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-light) 100%);
            color: white;
        }

        th {
            padding: 1rem;
            text-align: left;
            font-weight: 700;
            font-size: 0.9rem;
            letter-spacing: 0.3px;
            white-space: nowrap;
        }

        td {
            padding: 1rem;
            border-bottom: 1px solid var(--border);
            font-size: 0.95rem;
        }

        tbody tr {
            transition: all 0.3s;
        }

        tbody tr:hover {
            background: rgba(43, 88, 118, 0.03);
        }

        tbody tr.urgent {
            background: linear-gradient(90deg, rgba(255, 107, 107, 0.15) 0%, rgba(231, 76, 60, 0.05) 100%);
            border-left: 4px solid var(--danger);
            animation: urgentPulse 2s infinite;
        }

        tbody tr.urgent td {
            font-weight: 600;
        }

        .badge {
            display: inline-block;
            padding: 0.4rem 0.8rem;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
            letter-spacing: 0.3px;
        }

        .badge-active {
            background: rgba(39, 174, 96, 0.15);
            color: var(--success);
        }

        .badge-inactive {
            background: rgba(127, 140, 141, 0.15);
            color: var(--text-secondary);
        }

        .badge-urgent {
            background: rgba(231, 76, 60, 0.15);
            color: var(--danger);
            animation: badgePulse 1.5s infinite;
        }

        .badge-ipc {
            background: rgba(52, 152, 219, 0.15);
            color: #3498db;
        }

        .badge-icl {
            background: rgba(155, 89, 182, 0.15);
            color: #9b59b6;
        }

        .badge-fixed {
            background: rgba(243, 156, 18, 0.15);
            color: #f39c12;
        }

        .actions {
            display: flex;
            gap: 0.5rem;
        }

        .btn-icon {
            padding: 0.5rem;
            border: none;
            background: transparent;
            cursor: pointer;
            font-size: 1.2rem;
            border-radius: 6px;
            transition: all 0.3s;
        }

        .btn-icon:hover {
            background: var(--bg-main);
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.6);
            z-index: 1000;
            align-items: center;
            justify-content: center;
            backdrop-filter: blur(4px);
            animation: fadeIn 0.3s;
        }

        .modal.show {
            display: flex;
        }

        .modal-content {
            background: white;
            border-radius: 20px;
            padding: 2.5rem;
            max-width: 600px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            animation: slideUp 0.3s ease;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
            padding-bottom: 1rem;
            border-bottom: 2px solid var(--border);
        }

        .modal-header h2 {
            font-size: 1.5rem;
            color: var(--primary);
        }

        .close-modal {
            background: none;
            border: none;
            font-size: 1.8rem;
            cursor: pointer;
            color: var(--text-secondary);
            transition: all 0.3s;
        }

        .close-modal:hover {
            color: var(--danger);
            transform: rotate(90deg);
        }

        .whatsapp-message {
            background: #e7ffdb;
            border: 2px solid #4caf50;
            border-radius: 12px;
            padding: 1.5rem;
            margin: 1rem 0;
            position: relative;
        }

        .whatsapp-message::before {
            content: 'üí¨';
            position: absolute;
            top: -15px;
            left: 20px;
            font-size: 1.5rem;
            background: white;
            padding: 0 8px;
        }

        .whatsapp-message h4 {
            color: #2e7d32;
            margin-bottom: 0.75rem;
            font-size: 1.1rem;
        }

        .message-text {
            background: white;
            padding: 1rem;
            border-radius: 8px;
            white-space: pre-line;
            font-size: 0.95rem;
            line-height: 1.6;
            margin-bottom: 1rem;
            border-left: 4px solid #4caf50;
        }

        .copy-btn {
            background: #25d366;
            color: white;
            border: none;
            padding: 0.75rem 1.5rem;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            transition: all 0.3s;
        }

        .copy-btn:hover {
            background: #128c7e;
            transform: translateY(-2px);
        }

        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .stat-card {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-light) 100%);
            color: white;
            padding: 2rem;
            border-radius: 16px;
            box-shadow: 0 8px 24px var(--shadow);
            position: relative;
            overflow: hidden;
        }

        .stat-card::before {
            content: '';
            position: absolute;
            top: -50%;
            right: -20%;
            width: 200px;
            height: 200px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 50%;
        }

        .stat-card-icon {
            font-size: 2.5rem;
            margin-bottom: 1rem;
            opacity: 0.9;
        }

        .stat-card-value {
            font-size: 2.5rem;
            font-weight: 800;
            margin-bottom: 0.5rem;
        }

        .stat-card-label {
            font-size: 1rem;
            opacity: 0.9;
        }

        .empty-state {
            text-align: center;
            padding: 4rem 2rem;
            color: var(--text-secondary);
        }

        .empty-state-icon {
            font-size: 4rem;
            margin-bottom: 1rem;
            opacity: 0.3;
        }

        .empty-state h3 {
            font-size: 1.5rem;
            margin-bottom: 0.5rem;
            color: var(--text-primary);
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateY(-20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }

        @keyframes urgentPulse {
            0%, 100% { box-shadow: 0 0 0 0 rgba(231, 76, 60, 0.4); }
            50% { box-shadow: 0 0 20px 0 rgba(231, 76, 60, 0.2); }
        }

        @keyframes badgePulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }

        @media (max-width: 768px) {
            .header-content {
                flex-direction: column;
                gap: 1rem;
            }

            .form-grid {
                grid-template-columns: 1fr;
            }

            .filters {
                flex-direction: column;
                align-items: stretch;
            }

            .tabs {
                overflow-x: auto;
            }

            table {
                font-size: 0.85rem;
            }

            th, td {
                padding: 0.75rem 0.5rem;
            }
        }

        .info-box {
            background: #e3f2fd;
            border-left: 4px solid #2196f3;
            padding: 1rem;
            border-radius: 8px;
            margin: 1rem 0;
        }

        .info-box strong {
            color: #1976d2;
        }

        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top-color: white;
            animation: spin 1s ease-in-out infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <header class="header">
        <div class="header-content">
            <div class="logo">
                <div class="logo-icon">üè¢</div>
                <div>
                    <h1>Gesti√≥n de Alquileres</h1>
                    <small style="opacity: 0.9;">Sistema Integral de Administraci√≥n</small>
                </div>
            </div>
            <div class="header-stats">
                <div class="stat-item">
                    <span class="stat-value" id="totalContracts">0</span>
                    <span class="stat-label">Contratos Activos</span>
                </div>
                <div class="stat-item">
                    <span class="stat-value" id="urgentContracts">0</span>
                    <span class="stat-label">Actualizaciones Pendientes</span>
                </div>
            </div>
        </div>
    </header>

    <div class="alert-banner" id="alertBanner">
        <span class="alert-icon">‚ö†Ô∏è</span>
        <div class="alert-content">
            <h3>Actualizaciones Urgentes</h3>
            <p id="alertText">Tienes contratos que actualizan en los pr√≥ximos 10 d√≠as</p>
        </div>
    </div>

    <div class="container">
        <div class="tabs">
            <button class="tab active" onclick="switchTab('dashboard')">üìä Dashboard</button>
            <button class="tab" onclick="switchTab('contracts')">üìã Contratos</button>
            <button class="tab" onclick="switchTab('new')">‚ûï Nuevo Contrato</button>
            <button class="tab" onclick="switchTab('indices')">üìà √çndices Actuales</button>
        </div>

        <!-- Dashboard Tab -->
        <div id="dashboard" class="tab-content active">
            <div class="dashboard-grid">
                <div class="stat-card">
                    <div class="stat-card-icon">üìë</div>
                    <div class="stat-card-value" id="dashTotalContracts">0</div>
                    <div class="stat-card-label">Total de Contratos</div>
                </div>
                <div class="stat-card" style="background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%);">
                    <div class="stat-card-icon">‚ö°</div>
                    <div class="stat-card-value" id="dashUrgent">0</div>
                    <div class="stat-card-label">Actualizan en 10 d√≠as</div>
                </div>
                <div class="stat-card" style="background: linear-gradient(135deg, #f39c12 0%, #e67e22 100%);">
                    <div class="stat-card-icon">üìÖ</div>
                    <div class="stat-card-value" id="dashExpiring">0</div>
                    <div class="stat-card-label">Vencen en 60 d√≠as</div>
                </div>
                <div class="stat-card" style="background: linear-gradient(135deg, #27ae60 0%, #229954 100%);">
                    <div class="stat-card-icon">üí∞</div>
                    <div class="stat-card-value" id="dashTotalValue">$0</div>
                    <div class="stat-card-label">Valor Total Mensual</div>
                </div>
            </div>

            <div class="card">
                <div class="card-header">
                    <h2 class="card-title">üîî Pr√≥ximas Actualizaciones de Monto</h2>
                </div>
                <div id="upcomingUpdates"></div>
            </div>

            <div class="card">
                <div class="card-header">
                    <h2 class="card-title">üìÖ Pr√≥ximas Finalizaciones de Contrato</h2>
                </div>
                <div id="upcomingExpirations"></div>
            </div>
        </div>

        <!-- Contracts Tab -->
        <div id="contracts" class="tab-content">
            <div class="card">
                <div class="card-header">
                    <h2 class="card-title">üìã Lista de Contratos</h2>
                    <button class="btn btn-primary" onclick="exportToCSV()">
                        üì• Exportar CSV
                    </button>
                </div>

                <div class="filters">
                    <div class="filter-group">
                        <label>Filtrar por estado:</label>
                        <select id="filterStatus" onchange="filterContracts()">
                            <option value="all">Todos</option>
                            <option value="active">Activos</option>
                            <option value="inactive">Finalizados</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <label>Filtrar por per√≠odo:</label>
                        <select id="filterPeriod" onchange="filterContracts()">
                            <option value="all">Todos</option>
                            <option value="urgent">Actualizan en 10 d√≠as</option>
                            <option value="expiring">Vencen en 60 d√≠as</option>
                            <option value="thisMonth">Actualizan este mes</option>
                            <option value="nextMonth">Actualizan pr√≥ximo mes</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <label>Buscar:</label>
                        <input type="text" id="searchInput" placeholder="Direcci√≥n, propietario..." oninput="filterContracts()">
                    </div>
                </div>

                <div class="table-container">
                    <table id="contractsTable">
                        <thead>
                            <tr>
                                <th>Direcci√≥n</th>
                                <th>Propietario</th>
                                <th>Inquilino</th>
                                <th>Monto Actual</th>
                                <th>√çndice</th>
                                <th>Pr√≥xima Actualizaci√≥n</th>
                                <th>Nuevo Monto</th>
                                <th>Estado</th>
                                <th>Acciones</th>
                            </tr>
                        </thead>
                        <tbody id="contractsBody">
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- New Contract Tab -->
        <div id="new" class="tab-content">
            <div class="card">
                <div class="card-header">
                    <h2 class="card-title">‚ûï Nuevo Contrato de Alquiler</h2>
                </div>

                <form id="contractForm" onsubmit="saveContract(event)">
                    <h3 style="margin-bottom: 1rem; color: var(--primary);">üìç Datos de la Propiedad</h3>
                    <div class="form-grid">
                        <div class="form-group">
                            <label>Direcci√≥n de la Propiedad *</label>
                            <input type="text" id="address" required placeholder="Ej: Av. Corrientes 1234, CABA">
                        </div>
                    </div>

                    <h3 style="margin: 2rem 0 1rem; color: var(--primary);">üë§ Datos del Propietario</h3>
                    <div class="form-grid">
                        <div class="form-group">
                            <label>Nombre del Propietario *</label>
                            <input type="text" id="ownerName" required placeholder="Nombre completo">
                        </div>
                        <div class="form-group">
                            <label>Tel√©fono del Propietario *</label>
                            <input type="tel" id="ownerPhone" required placeholder="Ej: +54 9 11 1234-5678">
                        </div>
                        <div class="form-group">
                            <label>Email del Propietario</label>
                            <input type="email" id="ownerEmail" placeholder="email@ejemplo.com">
                        </div>
                    </div>

                    <h3 style="margin: 2rem 0 1rem; color: var(--primary);">üë• Datos del Inquilino</h3>
                    <div class="form-grid">
                        <div class="form-group">
                            <label>Nombre del Inquilino *</label>
                            <input type="text" id="tenantName" required placeholder="Nombre completo">
                        </div>
                        <div class="form-group">
                            <label>Tel√©fono del Inquilino *</label>
                            <input type="tel" id="tenantPhone" required placeholder="Ej: +54 9 11 1234-5678">
                        </div>
                        <div class="form-group">
                            <label>Email del Inquilino</label>
                            <input type="email" id="tenantEmail" placeholder="email@ejemplo.com">
                        </div>
                    </div>

                    <h3 style="margin: 2rem 0 1rem; color: var(--primary);">üìÑ Datos del Contrato</h3>
                    <div class="form-grid">
                        <div class="form-group">
                            <label>Fecha de Inicio del Contrato *</label>
                            <input type="date" id="startDate" required>
                        </div>
                        <div class="form-group">
                            <label>Duraci√≥n del Contrato (a√±os) *</label>
                            <input type="number" id="duration" required min="1" placeholder="Ej: 2">
                        </div>
                        <div class="form-group">
                            <label>Frecuencia de Actualizaci√≥n (meses) *</label>
                            <input type="number" id="updateFrequency" required min="1" max="12" placeholder="Ej: 3">
                        </div>
                        <div class="form-group">
                            <label>Tipo de √çndice *</label>
                            <select id="indexType" required>
                                <option value="">Seleccionar...</option>
                                <option value="IPC">IPC - √çndice de Precios al Consumidor</option>
                                <option value="ICL">ICL - √çndice Contratos de Locaci√≥n</option>
                                <option value="FIXED">Porcentaje Fijo</option>
                            </select>
                        </div>
                        <div class="form-group" id="fixedPercentageGroup" style="display: none;">
                            <label>Porcentaje de Aumento Fijo (%)</label>
                            <input type="number" id="fixedPercentage" step="0.01" placeholder="Ej: 15.5">
                        </div>
                        <div class="form-group">
                            <label>Monto Inicial del Contrato ($) *</label>
                            <input type="number" id="initialAmount" required step="0.01" placeholder="Ej: 150000">
                        </div>
                        <div class="form-group">
                            <label>¬øActualiza Dep√≥sito en Garant√≠a? *</label>
                            <select id="updatesDeposit" required>
                                <option value="yes">S√≠ - Se actualiza con cada ajuste</option>
                                <option value="no">No - Permanece fijo</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Estado del Contrato *</label>
                            <select id="status" required>
                                <option value="active">Activo</option>
                                <option value="inactive">Finalizado</option>
                            </select>
                        </div>
                    </div>

                    <div class="info-box">
                        <strong>‚ÑπÔ∏è Informaci√≥n:</strong> El sistema calcular√° autom√°ticamente las fechas de actualizaci√≥n, los montos seg√∫n el √≠ndice seleccionado, y la fecha de finalizaci√≥n del contrato. Te avisar√° 10 d√≠as antes de cada actualizaci√≥n y 60 d√≠as antes del vencimiento. Recuerda cargar los √≠ndices IPC e ICL manualmente cada mes en la pesta√±a "√çndices Actuales".
                    </div>

                    <div style="display: flex; gap: 1rem; justify-content: flex-end; margin-top: 2rem;">
                        <button type="button" class="btn btn-secondary" onclick="resetForm()">
                            ‚ùå Cancelar
                        </button>
                        <button type="submit" class="btn btn-primary">
                            üíæ Guardar Contrato
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Indices Tab -->
        <div id="indices" class="tab-content">
            <div class="card" style="background: linear-gradient(135deg, rgba(43, 88, 118, 0.05) 0%, rgba(78, 137, 174, 0.05) 100%); border: 2px solid var(--primary);">
                <div class="card-header">
                    <h2 class="card-title">‚ûï Cargar √çndices Mensuales</h2>
                </div>

                <div class="info-box" style="background: #fff3cd; border-left-color: var(--orange);">
                    <strong>üìù Importante:</strong> Debes cargar manualmente los valores de IPC e ICL cada mes. Estos valores se utilizan para calcular las actualizaciones de alquiler. Puedes obtener los datos oficiales de INDEC o www.arquiler.com
                </div>

                <form onsubmit="saveIndices(event)" style="background: white; padding: 2rem; border-radius: 12px; border: 2px solid var(--border); margin-top: 1.5rem;">
                    <h3 style="margin-bottom: 1.5rem; color: var(--primary); font-size: 1.2rem;">üìä Ingresar √çndices del Mes</h3>
                    <div class="indices-input-grid">
                        <div class="form-group">
                            <label>IPC Mensual (%) *</label>
                            <input type="number" id="ipcInput" step="0.01" placeholder="Ej: 25.5" required style="font-size: 1.1rem; font-weight: 600;">
                            <small style="color: var(--text-secondary); margin-top: 0.5rem; display: block;">√çndice de Precios al Consumidor</small>
                        </div>
                        <div class="form-group">
                            <label>ICL Mensual (%) *</label>
                            <input type="number" id="iclInput" step="0.01" placeholder="Ej: 28.3" required style="font-size: 1.1rem; font-weight: 600;">
                            <small style="color: var(--text-secondary); margin-top: 0.5rem; display: block;">√çndice Contratos de Locaci√≥n</small>
                        </div>
                        <div class="form-group">
                            <label>Per√≠odo (Mes/A√±o) *</label>
                            <input type="month" id="periodInput" required style="font-size: 1.1rem; font-weight: 600;">
                            <small style="color: var(--text-secondary); margin-top: 0.5rem; display: block;">Selecciona el mes correspondiente</small>
                        </div>
                    </div>
                    <button type="submit" class="btn btn-primary" style="margin-top: 1.5rem; font-size: 1.1rem; padding: 1.2rem 2.5rem;">
                        ‚úÖ Guardar √çndices del Mes
                    </button>
                </form>
            </div>

            <div class="card" style="margin-top: 2rem;">
                <div class="card-header">
                    <h2 class="card-title">üìà √çndices Vigentes para C√°lculos</h2>
                </div>

                <div class="info-box">
                    <strong>‚ÑπÔ∏è √çndices Actuales:</strong> Estos son los √∫ltimos valores cargados que se usan para calcular las actualizaciones. √öltima carga: <span id="lastUpdate">---</span>
                </div>

                <div class="dashboard-grid">
                    <div class="stat-card" style="background: linear-gradient(135deg, #3498db 0%, #2980b9 100%);">
                        <div class="stat-card-icon">üìä</div>
                        <div class="stat-card-value" id="ipcValue">---</div>
                        <div class="stat-card-label">IPC - √öltimo mes (%)</div>
                    </div>
                    <div class="stat-card" style="background: linear-gradient(135deg, #9b59b6 0%, #8e44ad 100%);">
                        <div class="stat-card-icon">üìà</div>
                        <div class="stat-card-value" id="iclValue">---</div>
                        <div class="stat-card-label">ICL - √öltimo mes (%)</div>
                    </div>
                </div>

                <div class="card" style="margin-top: 2rem;">
                    <h3 style="margin-bottom: 1rem;">üìã Hist√≥rico de √çndices Cargados</h3>
                    <div class="table-container">
                        <table>
                            <thead>
                                <tr>
                                    <th>Per√≠odo</th>
                                    <th>IPC (%)</th>
                                    <th>ICL (%)</th>
                                    <th>Acciones</th>
                                </tr>
                            </thead>
                            <tbody id="indicesHistory">
                                <tr>
                                    <td colspan="4" style="text-align: center; padding: 2rem;">
                                        No hay datos hist√≥ricos. Agrega el primer registro arriba.
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- WhatsApp Message Modal -->
    <div id="whatsappModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>üí¨ Mensajes de Actualizaci√≥n</h2>
                <button class="close-modal" onclick="closeModal('whatsappModal')">√ó</button>
            </div>

            <div id="modalContent"></div>
        </div>
    </div>

    <!-- Edit Contract Modal -->
    <div id="editModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>‚úèÔ∏è Editar Contrato</h2>
                <button class="close-modal" onclick="closeModal('editModal')">√ó</button>
            </div>

            <form id="editForm" onsubmit="updateContract(event)">
                <input type="hidden" id="editId">
                
                <div class="form-grid">
                    <div class="form-group">
                        <label>Direcci√≥n *</label>
                        <input type="text" id="editAddress" required>
                    </div>
                    <div class="form-group">
                        <label>Propietario *</label>
                        <input type="text" id="editOwnerName" required>
                    </div>
                    <div class="form-group">
                        <label>Tel. Propietario *</label>
                        <input type="tel" id="editOwnerPhone" required>
                    </div>
                    <div class="form-group">
                        <label>Inquilino *</label>
                        <input type="text" id="editTenantName" required>
                    </div>
                    <div class="form-group">
                        <label>Tel. Inquilino *</label>
                        <input type="tel" id="editTenantPhone" required>
                    </div>
                    <div class="form-group">
                        <label>Fecha de Inicio *</label>
                        <input type="date" id="editStartDate" required>
                    </div>
                    <div class="form-group">
                        <label>Monto Actual ($) *</label>
                        <input type="number" id="editCurrentAmount" required step="0.01">
                    </div>
                    <div class="form-group">
                        <label>Estado *</label>
                        <select id="editStatus" required>
                            <option value="active">Activo</option>
                            <option value="inactive">Finalizado</option>
                        </select>
                    </div>
                </div>

                <div style="display: flex; gap: 1rem; justify-content: flex-end; margin-top: 2rem;">
                    <button type="button" class="btn btn-secondary" onclick="closeModal('editModal')">
                        Cancelar
                    </button>
                    <button type="submit" class="btn btn-primary">
                        üíæ Guardar Cambios
                    </button>
                </div>
            </form>
        </div>
    </div>

    <script>
        // Storage and State Management
        let contracts = JSON.parse(localStorage.getItem('contracts')) || [];
        let indices = JSON.parse(localStorage.getItem('indices')) || { ipc: null, icl: null, lastUpdate: null };
        let indicesHistory = JSON.parse(localStorage.getItem('indicesHistory')) || [];

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            loadIndices();
            renderContracts();
            updateDashboard();
            checkAlerts();
            
            // Show index type conditional field
            document.getElementById('indexType').addEventListener('change', function() {
                const fixedGroup = document.getElementById('fixedPercentageGroup');
                if (this.value === 'FIXED') {
                    fixedGroup.style.display = 'block';
                    document.getElementById('fixedPercentage').required = true;
                } else {
                    fixedGroup.style.display = 'none';
                    document.getElementById('fixedPercentage').required = false;
                }
            });
        });

        // Tab Switching
        function switchTab(tabName) {
            document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            
            event.target.classList.add('active');
            document.getElementById(tabName).classList.add('active');

            if (tabName === 'contracts') {
                renderContracts();
            } else if (tabName === 'dashboard') {
                updateDashboard();
            } else if (tabName === 'indices') {
                renderIndicesHistory();
            }
        }

        // Save Indices
        function saveIndices(event) {
            event.preventDefault();

            const ipc = parseFloat(document.getElementById('ipcInput').value);
            const icl = parseFloat(document.getElementById('iclInput').value);
            const period = document.getElementById('periodInput').value;

            indices = {
                ipc: ipc,
                icl: icl,
                lastUpdate: new Date().toISOString()
            };

            // Add to history
            indicesHistory.unshift({
                period: period,
                ipc: ipc,
                icl: icl,
                date: new Date().toISOString()
            });

            // Keep only last 12 months
            if (indicesHistory.length > 12) {
                indicesHistory = indicesHistory.slice(0, 12);
            }

            localStorage.setItem('indices', JSON.stringify(indices));
            localStorage.setItem('indicesHistory', JSON.stringify(indicesHistory));

            loadIndices();
            renderIndicesHistory();
            alert('‚úÖ √çndices guardados correctamente');
            
            // Clear form
            document.getElementById('ipcInput').value = '';
            document.getElementById('iclInput').value = '';
            document.getElementById('periodInput').value = '';
        }

        // Load Indices
        function loadIndices() {
            document.getElementById('ipcValue').textContent = indices.ipc ? `${indices.ipc}%` : '---';
            document.getElementById('iclValue').textContent = indices.icl ? `${indices.icl}%` : '---';
            document.getElementById('lastUpdate').textContent = indices.lastUpdate ? formatDate(indices.lastUpdate) : '---';
        }

        // Render Indices History
        function renderIndicesHistory() {
            const tbody = document.getElementById('indicesHistory');

            if (indicesHistory.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="4" style="text-align: center; padding: 2rem;">
                            No hay datos hist√≥ricos. Agrega el primer registro arriba.
                        </td>
                    </tr>
                `;
                return;
            }

            tbody.innerHTML = indicesHistory.map((item, index) => `
                <tr>
                    <td><strong>${formatPeriod(item.period)}</strong></td>
                    <td>${item.ipc}%</td>
                    <td>${item.icl}%</td>
                    <td>
                        <button class="btn-icon" onclick="deleteIndexHistory(${index})" title="Eliminar">
                            üóëÔ∏è
                        </button>
                    </td>
                </tr>
            `).join('');
        }

        // Delete Index History
        function deleteIndexHistory(index) {
            if (!confirm('¬øEliminar este registro hist√≥rico?')) return;
            
            indicesHistory.splice(index, 1);
            localStorage.setItem('indicesHistory', JSON.stringify(indicesHistory));
            renderIndicesHistory();
        }

        // Format Period (YYYY-MM to readable format)
        function formatPeriod(period) {
            const [year, month] = period.split('-');
            const months = ['Enero', 'Febrero', 'Marzo', 'Abril', 'Mayo', 'Junio', 
                           'Julio', 'Agosto', 'Septiembre', 'Octubre', 'Noviembre', 'Diciembre'];
            return `${months[parseInt(month) - 1]} ${year}`;
        }

        // Save Contract
        function saveContract(event) {
            event.preventDefault();

            const startDate = document.getElementById('startDate').value;
            const duration = parseInt(document.getElementById('duration').value);
            
            // Calculate end date
            const endDate = new Date(startDate);
            endDate.setFullYear(endDate.getFullYear() + duration);

            const contract = {
                id: Date.now(),
                address: document.getElementById('address').value,
                ownerName: document.getElementById('ownerName').value,
                ownerPhone: document.getElementById('ownerPhone').value,
                ownerEmail: document.getElementById('ownerEmail').value,
                tenantName: document.getElementById('tenantName').value,
                tenantPhone: document.getElementById('tenantPhone').value,
                tenantEmail: document.getElementById('tenantEmail').value,
                startDate: startDate,
                endDate: endDate.toISOString().split('T')[0],
                duration: duration,
                updateFrequency: parseInt(document.getElementById('updateFrequency').value),
                indexType: document.getElementById('indexType').value,
                fixedPercentage: document.getElementById('indexType').value === 'FIXED' ? 
                    parseFloat(document.getElementById('fixedPercentage').value) : null,
                initialAmount: parseFloat(document.getElementById('initialAmount').value),
                currentAmount: parseFloat(document.getElementById('initialAmount').value),
                updatesDeposit: document.getElementById('updatesDeposit').value,
                currentDeposit: parseFloat(document.getElementById('initialAmount').value),
                status: document.getElementById('status').value,
                lastUpdate: startDate,
                updateHistory: []
            };

            contracts.push(contract);
            localStorage.setItem('contracts', JSON.stringify(contracts));

            alert('‚úÖ Contrato guardado exitosamente');
            resetForm();
            switchTab('contracts');
            renderContracts();
            updateDashboard();
        }

        // Calculate Next Update Date
        function calculateNextUpdate(contract) {
            const lastUpdate = new Date(contract.lastUpdate);
            lastUpdate.setMonth(lastUpdate.getMonth() + contract.updateFrequency);
            return lastUpdate;
        }

        // Calculate Contract End Date
        function calculateEndDate(contract) {
            return new Date(contract.endDate);
        }

        // Check if Contract is Expiring (within 60 days)
        function isExpiring(endDate) {
            const today = new Date();
            const end = new Date(endDate);
            const diffTime = end - today;
            const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
            return diffDays >= 0 && diffDays <= 60;
        }

        // Calculate New Amount
        function calculateNewAmount(contract) {
            if (contract.indexType === 'FIXED') {
                return contract.currentAmount * (1 + contract.fixedPercentage / 100);
            }
            
            const index = contract.indexType === 'IPC' ? indices.ipc : indices.icl;
            if (!index) return contract.currentAmount;
            
            return contract.currentAmount * (1 + index / 100);
        }

        // Calculate New Deposit
        function calculateNewDeposit(contract) {
            if (!contract.updatesDeposit || contract.updatesDeposit === 'no') {
                return contract.currentDeposit || contract.initialAmount;
            }
            // If updates deposit, it should equal the new rental amount
            return calculateNewAmount(contract);
        }

        // Check if Update is Urgent (within 10 days)
        function isUrgent(nextUpdateDate) {
            const today = new Date();
            const update = new Date(nextUpdateDate);
            const diffTime = update - today;
            const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
            return diffDays >= 0 && diffDays <= 10;
        }

        // Get Days Until Update
        function getDaysUntil(nextUpdateDate) {
            const today = new Date();
            const update = new Date(nextUpdateDate);
            const diffTime = update - today;
            const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
            return diffDays;
        }

        // Format Currency
        function formatCurrency(amount) {
            return new Intl.NumberFormat('es-AR', {
                style: 'currency',
                currency: 'ARS',
                minimumFractionDigits: 2
            }).format(amount);
        }

        // Format Date
        function formatDate(dateString) {
            return new Date(dateString).toLocaleDateString('es-AR', {
                year: 'numeric',
                month: 'long',
                day: 'numeric'
            });
        }

        // Render Contracts Table
        function renderContracts() {
            const tbody = document.getElementById('contractsBody');
            const activeContracts = contracts.filter(c => c.status === 'active');

            if (activeContracts.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="9">
                            <div class="empty-state">
                                <div class="empty-state-icon">üìã</div>
                                <h3>No hay contratos registrados</h3>
                                <p>Comienza agregando tu primer contrato de alquiler</p>
                            </div>
                        </td>
                    </tr>
                `;
                return;
            }

            tbody.innerHTML = activeContracts.map(contract => {
                const nextUpdate = calculateNextUpdate(contract);
                const newAmount = calculateNewAmount(contract);
                const urgent = isUrgent(nextUpdate);
                const daysUntil = getDaysUntil(nextUpdate);

                return `
                    <tr class="${urgent ? 'urgent' : ''}">
                        <td><strong>${contract.address}</strong></td>
                        <td>${contract.ownerName}</td>
                        <td>${contract.tenantName}</td>
                        <td><strong>${formatCurrency(contract.currentAmount)}</strong></td>
                        <td>
                            <span class="badge badge-${contract.indexType.toLowerCase()}">
                                ${contract.indexType}
                            </span>
                        </td>
                        <td>
                            ${formatDate(nextUpdate)}
                            ${urgent ? `<br><span class="badge badge-urgent">‚ö†Ô∏è ${daysUntil} d√≠as</span>` : ''}
                        </td>
                        <td><strong>${formatCurrency(newAmount)}</strong></td>
                        <td>
                            <span class="badge badge-${contract.status === 'active' ? 'active' : 'inactive'}">
                                ${contract.status === 'active' ? 'Activo' : 'Finalizado'}
                            </span>
                        </td>
                        <td>
                            <div class="actions">
                                <button class="btn-icon" onclick="generateWhatsAppMessage(${contract.id})" title="Generar mensaje WhatsApp">
                                    üí¨
                                </button>
                                <button class="btn-icon" onclick="editContract(${contract.id})" title="Editar">
                                    ‚úèÔ∏è
                                </button>
                                <button class="btn-icon" onclick="deleteContract(${contract.id})" title="Eliminar">
                                    üóëÔ∏è
                                </button>
                            </div>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        // Filter Contracts
        function filterContracts() {
            const status = document.getElementById('filterStatus').value;
            const period = document.getElementById('filterPeriod').value;
            const search = document.getElementById('searchInput').value.toLowerCase();

            let filtered = contracts;

            if (status !== 'all') {
                filtered = filtered.filter(c => c.status === status);
            }

            if (period !== 'all') {
                filtered = filtered.filter(c => {
                    const nextUpdate = calculateNextUpdate(c);
                    const endDate = calculateEndDate(c);
                    const daysUntilUpdate = getDaysUntil(nextUpdate);
                    const daysUntilExpiry = getDaysUntil(endDate);
                    const today = new Date();
                    const thisMonth = today.getMonth();
                    const nextMonth = (today.getMonth() + 1) % 12;
                    const updateMonth = nextUpdate.getMonth();

                    if (period === 'urgent') return daysUntilUpdate >= 0 && daysUntilUpdate <= 10;
                    if (period === 'expiring') return daysUntilExpiry >= 0 && daysUntilExpiry <= 60;
                    if (period === 'thisMonth') return updateMonth === thisMonth;
                    if (period === 'nextMonth') return updateMonth === nextMonth;
                    return true;
                });
            }

            if (search) {
                filtered = filtered.filter(c => 
                    c.address.toLowerCase().includes(search) ||
                    c.ownerName.toLowerCase().includes(search) ||
                    c.tenantName.toLowerCase().includes(search)
                );
            }

            // Temporarily store filtered contracts for rendering
            const originalContracts = contracts;
            contracts = filtered;
            renderContracts();
            contracts = originalContracts;
        }

        // Generate WhatsApp Messages
        function generateWhatsAppMessage(contractId) {
            const contract = contracts.find(c => c.id === contractId);
            if (!contract) return;

            const nextUpdate = calculateNextUpdate(contract);
            const newAmount = calculateNewAmount(contract);
            const newDeposit = calculateNewDeposit(contract);
            const increase = newAmount - contract.currentAmount;
            const increasePercent = (increase / contract.currentAmount * 100).toFixed(2);
            
            const currentDeposit = contract.currentDeposit || contract.initialAmount;
            const depositIncrease = newDeposit - currentDeposit;
            const depositUpdates = contract.updatesDeposit === 'yes';

            let depositInfo = depositUpdates ? 
                `‚Ä¢ Dep√≥sito actual: ${formatCurrency(currentDeposit)}
‚Ä¢ Nuevo dep√≥sito: ${formatCurrency(newDeposit)}
‚Ä¢ Incremento dep√≥sito: ${formatCurrency(depositIncrease)}` : 
                `‚Ä¢ Dep√≥sito en garant√≠a: ${formatCurrency(currentDeposit)} (sin cambios)`;

            const ownerMessage = `Hola ${contract.ownerName},

Le informo que el contrato de alquiler de la propiedad ubicada en ${contract.address} se actualizar√° el pr√≥ximo ${formatDate(nextUpdate)}.

Datos de la actualizaci√≥n:
‚Ä¢ Monto alquiler actual: ${formatCurrency(contract.currentAmount)}
‚Ä¢ Nuevo monto alquiler: ${formatCurrency(newAmount)}
‚Ä¢ Incremento: ${formatCurrency(increase)} (${increasePercent}%)
‚Ä¢ √çndice aplicado: ${contract.indexType}
${depositInfo}

El inquilino ser√° notificado de este ajuste.

Saludos cordiales,
Inmobiliaria`;

            const tenantMessage = `Hola ${contract.tenantName},

Le informo que el alquiler de ${contract.address} se actualizar√° el pr√≥ximo ${formatDate(nextUpdate)}.

Datos de la actualizaci√≥n:
‚Ä¢ Monto alquiler actual: ${formatCurrency(contract.currentAmount)}
‚Ä¢ Nuevo monto alquiler: ${formatCurrency(newAmount)}
‚Ä¢ Incremento: ${formatCurrency(increase)} (${increasePercent}%)
‚Ä¢ √çndice aplicado: ${contract.indexType}
${depositInfo}

El nuevo monto ser√° efectivo a partir de la fecha indicada.${depositUpdates ? '\nEl dep√≥sito en garant√≠a debe ser actualizado seg√∫n el nuevo monto de alquiler.' : ''}

Saludos cordiales,
Administraci√≥n`;

            document.getElementById('modalContent').innerHTML = `
                <div class="whatsapp-message">
                    <h4>üì± Mensaje para el Propietario</h4>
                    <div class="message-text">${ownerMessage}</div>
                    <button class="copy-btn" onclick="copyToClipboard(\`${ownerMessage.replace(/`/g, '\\`')}\`, 'propietario')">
                        üìã Copiar mensaje
                    </button>
                </div>

                <div class="whatsapp-message">
                    <h4>üì± Mensaje para el Inquilino</h4>
                    <div class="message-text">${tenantMessage}</div>
                    <button class="copy-btn" onclick="copyToClipboard(\`${tenantMessage.replace(/`/g, '\\`')}\`, 'inquilino')">
                        üìã Copiar mensaje
                    </button>
                </div>
            `;

            document.getElementById('whatsappModal').classList.add('show');
        }

        // Generate Expiration Messages
        function generateExpirationMessages(contractId) {
            const contract = contracts.find(c => c.id === contractId);
            if (!contract) return;

            const endDate = calculateEndDate(contract);
            const daysUntilExpiry = getDaysUntil(endDate);

            const ownerExpirationMessage = `Hola ${contract.ownerName},

Le recordamos que el contrato de alquiler de la propiedad ubicada en ${contract.address} finalizar√° el ${formatDate(endDate)}.

Faltan ${daysUntilExpiry} d√≠as para el vencimiento del contrato.

Por favor, ind√≠quenos si desea renovar el contrato o finalizar la relaci√≥n locativa. De acuerdo a la normativa vigente, el inquilino debe ser notificado con la debida antelaci√≥n.

Quedamos a su disposici√≥n.

Saludos cordiales,
Inmobiliaria`;

            const tenantExpirationMessage = `Hola ${contract.tenantName},

Por medio de la presente le informamos que el contrato de alquiler de ${contract.address} finalizar√° el ${formatDate(endDate)}.

Faltan ${daysUntilExpiry} d√≠as para el vencimiento del contrato.

Conforme a lo establecido en la Ley 27.551, le notificamos formalmente sobre la proximidad del vencimiento contractual. Por favor, ind√≠quenos su intenci√≥n respecto a:
‚Ä¢ Renovaci√≥n del contrato
‚Ä¢ Finalizaci√≥n de la locaci√≥n

Quedamos a su disposici√≥n para coordinar los detalles.

Saludos cordiales,
Administraci√≥n`;

            document.getElementById('modalContent').innerHTML = `
                <div class="whatsapp-message warning">
                    <h4>üìÖ Vencimiento - Mensaje para el Propietario</h4>
                    <div class="message-text">${ownerExpirationMessage}</div>
                    <button class="copy-btn" onclick="copyToClipboard(\`${ownerExpirationMessage.replace(/`/g, '\\`')}\`, 'propietario (vencimiento)')">
                        üìã Copiar mensaje
                    </button>
                </div>

                <div class="whatsapp-message warning">
                    <h4>üìÖ Vencimiento - Mensaje para el Inquilino</h4>
                    <div class="message-text">${tenantExpirationMessage}</div>
                    <button class="copy-btn" onclick="copyToClipboard(\`${tenantExpirationMessage.replace(/`/g, '\\`')}\`, 'inquilino (vencimiento)')">
                        üìã Copiar mensaje
                    </button>
                </div>
            `;

            document.getElementById('whatsappModal').classList.add('show');
        }

        // Copy to Clipboard
        function copyToClipboard(text, recipient) {
            navigator.clipboard.writeText(text).then(() => {
                alert(`‚úÖ Mensaje para ${recipient} copiado al portapapeles`);
            });
        }

        // Edit Contract
        function editContract(contractId) {
            const contract = contracts.find(c => c.id === contractId);
            if (!contract) return;

            document.getElementById('editId').value = contract.id;
            document.getElementById('editAddress').value = contract.address;
            document.getElementById('editOwnerName').value = contract.ownerName;
            document.getElementById('editOwnerPhone').value = contract.ownerPhone;
            document.getElementById('editTenantName').value = contract.tenantName;
            document.getElementById('editTenantPhone').value = contract.tenantPhone;
            document.getElementById('editStartDate').value = contract.startDate;
            document.getElementById('editCurrentAmount').value = contract.currentAmount;
            document.getElementById('editStatus').value = contract.status;

            document.getElementById('editModal').classList.add('show');
        }

        // Update Contract
        function updateContract(event) {
            event.preventDefault();

            const id = parseInt(document.getElementById('editId').value);
            const contract = contracts.find(c => c.id === id);

            const newStartDate = document.getElementById('editStartDate').value;
            
            // Recalculate end date if start date changed
            if (newStartDate !== contract.startDate) {
                const endDate = new Date(newStartDate);
                endDate.setFullYear(endDate.getFullYear() + contract.duration);
                contract.endDate = endDate.toISOString().split('T')[0];
                contract.startDate = newStartDate;
            }

            contract.address = document.getElementById('editAddress').value;
            contract.ownerName = document.getElementById('editOwnerName').value;
            contract.ownerPhone = document.getElementById('editOwnerPhone').value;
            contract.tenantName = document.getElementById('editTenantName').value;
            contract.tenantPhone = document.getElementById('editTenantPhone').value;
            contract.currentAmount = parseFloat(document.getElementById('editCurrentAmount').value);
            contract.status = document.getElementById('editStatus').value;

            localStorage.setItem('contracts', JSON.stringify(contracts));

            alert('‚úÖ Contrato actualizado exitosamente');
            closeModal('editModal');
            renderContracts();
            updateDashboard();
        }

        // Delete Contract
        function deleteContract(contractId) {
            if (!confirm('¬øEst√° seguro de eliminar este contrato?')) return;

            contracts = contracts.filter(c => c.id !== contractId);
            localStorage.setItem('contracts', JSON.stringify(contracts));

            alert('‚úÖ Contrato eliminado');
            renderContracts();
            updateDashboard();
        }

        // Update Dashboard
        function updateDashboard() {
            const activeContracts = contracts.filter(c => c.status === 'active');
            
            let urgentCount = 0;
            let expiringCount = 0;
            let totalValue = 0;

            activeContracts.forEach(contract => {
                const nextUpdate = calculateNextUpdate(contract);
                const endDate = calculateEndDate(contract);
                const daysUntilUpdate = getDaysUntil(nextUpdate);
                const daysUntilExpiry = getDaysUntil(endDate);

                if (daysUntilUpdate >= 0 && daysUntilUpdate <= 10) urgentCount++;
                if (daysUntilExpiry >= 0 && daysUntilExpiry <= 60) expiringCount++;
                totalValue += contract.currentAmount;
            });

            document.getElementById('totalContracts').textContent = activeContracts.length;
            document.getElementById('urgentContracts').textContent = urgentCount;
            document.getElementById('dashTotalContracts').textContent = activeContracts.length;
            document.getElementById('dashUrgent').textContent = urgentCount;
            document.getElementById('dashExpiring').textContent = expiringCount;
            document.getElementById('dashTotalValue').textContent = formatCurrency(totalValue);

            renderUpcomingUpdates();
            renderUpcomingExpirations();
        }

        // Render Upcoming Updates
        function renderUpcomingUpdates() {
            const container = document.getElementById('upcomingUpdates');
            const activeContracts = contracts.filter(c => c.status === 'active');
            
            const upcoming = activeContracts
                .map(contract => ({
                    contract,
                    nextUpdate: calculateNextUpdate(contract),
                    daysUntil: getDaysUntil(calculateNextUpdate(contract))
                }))
                .filter(item => item.daysUntil >= 0 && item.daysUntil <= 30)
                .sort((a, b) => a.daysUntil - b.daysUntil);

            if (upcoming.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">‚úÖ</div>
                        <h3>No hay actualizaciones pr√≥ximas</h3>
                        <p>No hay contratos que actualicen en los pr√≥ximos 30 d√≠as</p>
                    </div>
                `;
                return;
            }

            container.innerHTML = `
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>Direcci√≥n</th>
                                <th>D√≠as restantes</th>
                                <th>Fecha de actualizaci√≥n</th>
                                <th>Fecha fin contrato</th>
                                <th>Monto actual</th>
                                <th>Nuevo monto</th>
                                <th>Acci√≥n</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${upcoming.map(item => {
                                const newAmount = calculateNewAmount(item.contract);
                                const endDate = calculateEndDate(item.contract);
                                const isUrgentUpdate = item.daysUntil <= 10;
                                return `
                                    <tr class="${isUrgentUpdate ? 'urgent' : ''}">
                                        <td><strong>${item.contract.address}</strong></td>
                                        <td>
                                            <span class="badge ${isUrgentUpdate ? 'badge-urgent' : 'badge-active'}">
                                                ${item.daysUntil} d√≠as
                                            </span>
                                        </td>
                                        <td>${formatDate(item.nextUpdate)}</td>
                                        <td>${formatDate(endDate)}</td>
                                        <td>${formatCurrency(item.contract.currentAmount)}</td>
                                        <td><strong>${formatCurrency(newAmount)}</strong></td>
                                        <td>
                                            <button class="btn btn-primary" onclick="generateWhatsAppMessage(${item.contract.id})" style="padding: 0.5rem 1rem; font-size: 0.9rem;">
                                                üí¨ Notificar
                                            </button>
                                        </td>
                                    </tr>
                                `;
                            }).join('')}
                        </tbody>
                    </table>
                </div>
            `;
        }

        // Render Upcoming Expirations
        function renderUpcomingExpirations() {
            const container = document.getElementById('upcomingExpirations');
            const activeContracts = contracts.filter(c => c.status === 'active');
            
            const expiring = activeContracts
                .map(contract => ({
                    contract,
                    endDate: calculateEndDate(contract),
                    daysUntil: getDaysUntil(calculateEndDate(contract))
                }))
                .filter(item => item.daysUntil >= 0 && item.daysUntil <= 90)
                .sort((a, b) => a.daysUntil - b.daysUntil);

            if (expiring.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">‚úÖ</div>
                        <h3>No hay contratos pr√≥ximos a vencer</h3>
                        <p>No hay contratos que finalicen en los pr√≥ximos 90 d√≠as</p>
                    </div>
                `;
                return;
            }

            container.innerHTML = `
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>Direcci√≥n</th>
                                <th>Propietario</th>
                                <th>Inquilino</th>
                                <th>D√≠as restantes</th>
                                <th>Fecha de finalizaci√≥n</th>
                                <th>Acci√≥n</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${expiring.map(item => {
                                const isExpiringUrgent = item.daysUntil <= 60;
                                return `
                                    <tr class="${isExpiringUrgent ? 'expiring' : ''}">
                                        <td><strong>${item.contract.address}</strong></td>
                                        <td>${item.contract.ownerName}</td>
                                        <td>${item.contract.tenantName}</td>
                                        <td>
                                            <span class="badge ${isExpiringUrgent ? 'badge-expiring' : 'badge-active'}">
                                                ${item.daysUntil} d√≠as
                                            </span>
                                        </td>
                                        <td>${formatDate(item.endDate)}</td>
                                        <td>
                                            <button class="btn btn-warning" onclick="generateExpirationMessages(${item.contract.id})" style="padding: 0.5rem 1rem; font-size: 0.9rem;">
                                                üìÖ Notificar Vencimiento
                                            </button>
                                        </td>
                                    </tr>
                                `;
                            }).join('')}
                        </tbody>
                    </table>
                </div>
            `;
        }

        // Check Alerts
        function checkAlerts() {
            const activeContracts = contracts.filter(c => c.status === 'active');
            
            const urgentUpdates = activeContracts.filter(contract => {
                const nextUpdate = calculateNextUpdate(contract);
                return isUrgent(nextUpdate);
            });

            const expiringContracts = activeContracts.filter(contract => {
                const endDate = calculateEndDate(contract);
                return isExpiring(endDate);
            });

            // Update alerts
            if (urgentUpdates.length > 0) {
                document.getElementById('alertUpdateBanner').classList.add('show');
                document.getElementById('alertUpdateText').textContent = 
                    `Tienes ${urgentUpdates.length} contrato${urgentUpdates.length > 1 ? 's' : ''} que actualiza${urgentUpdates.length > 1 ? 'n' : ''} en los pr√≥ximos 10 d√≠as`;
            }

            // Expiration alerts
            if (expiringContracts.length > 0) {
                document.getElementById('alertExpirationBanner').classList.add('show');
                document.getElementById('alertExpirationText').textContent = 
                    `Tienes ${expiringContracts.length} contrato${expiringContracts.length > 1 ? 's' : ''} que vence${expiringContracts.length > 1 ? 'n' : ''} en los pr√≥ximos 60 d√≠as`;
            }
        }

        // Export to CSV
        function exportToCSV() {
            const activeContracts = contracts.filter(c => c.status === 'active');
            
            let csv = 'Direcci√≥n,Propietario,Tel. Propietario,Inquilino,Tel. Inquilino,Monto Actual,√çndice,Pr√≥xima Actualizaci√≥n,Nuevo Monto,Estado\n';
            
            activeContracts.forEach(contract => {
                const nextUpdate = calculateNextUpdate(contract);
                const newAmount = calculateNewAmount(contract);
                
                csv += `"${contract.address}","${contract.ownerName}","${contract.ownerPhone}","${contract.tenantName}","${contract.tenantPhone}",${contract.currentAmount},"${contract.indexType}","${formatDate(nextUpdate)}",${newAmount},"${contract.status}"\n`;
            });

            const blob = new Blob([csv], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `contratos_${new Date().toISOString().split('T')[0]}.csv`;
            a.click();
        }

        // Reset Form
        function resetForm() {
            document.getElementById('contractForm').reset();
        }

        // Close Modal
        function closeModal(modalId) {
            document.getElementById(modalId).classList.remove('show');
        }

        // Close modal on outside click
        document.querySelectorAll('.modal').forEach(modal => {
            modal.addEventListener('click', function(e) {
                if (e.target === this) {
                    this.classList.remove('show');
                }
            });
        });
    </script>
</body>
</html>